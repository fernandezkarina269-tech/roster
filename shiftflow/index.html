<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamArt V110 - SALES FIXED</title>
    <style>
        :root { --gold: #FFD700; --bg: #121212; --accent: #1e293b; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: #f8fafc; color: #0f172a; padding-bottom: 60px; }
        .hidden { display: none !important; }
        
        /* LOGIN */
        #view-login { position: fixed; inset: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: #fff; padding: 40px; border-radius: 24px; text-align: center; width: 340px; border: 4px solid var(--gold); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; font-weight: 600; transition: 0.3s; }
        input:focus { border-color: var(--gold); outline: none; }
        .btn-main { padding: 16px; width: 100%; background: #000; color: #fff; border: none; font-weight: 800; cursor: pointer; border-radius: 12px; text-transform: uppercase; margin-top: 12px; }
        .btn-gold { background: var(--gold); color: #000; }

        /* NAV */
        .nav { background: #000; color: #fff; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid var(--gold); }
        .nav-actions { display: flex; gap: 10px; }
        
        /* TABLES */
        .pod-card { background: white; border-radius: 16px; margin: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e2e8f0; }
        .pod-header { background: #f1f5f9; padding: 16px 20px; font-weight: 800; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; }
        table { width: 100%; border-collapse: collapse; min-width: 1300px; }
        th { background: #0f172a; color: white; padding: 14px; font-size: 12px; text-transform: uppercase; }
        td { padding: 14px; text-align: center; border-bottom: 1px solid #f1f5f9; font-weight: 700; font-size: 14px; }
        
        /* FIXED COLS */
        .sc-1 { position: sticky; left: 0; background: #fff !important; z-index: 10; width: 100px; border-right: 1px solid #e2e8f0; }
        .sc-2 { position: sticky; left: 100px; background: #fff !important; z-index: 10; width: 120px; border-right: 1px solid #e2e8f0; }
        .sc-3 { position: sticky; left: 220px; background: #fff !important; z-index: 10; border-right: 2px solid #cbd5e1; width: 180px; text-align: left; padding-left: 15px; }

        /* STATUS COLORS */
        .st-WORKING { color: #10b981 !important; font-weight: 900 !important; font-size: 18px; }
        .st-OFF { color: #f97316 !important; font-weight: 900 !important; } 
        .st-SICK { color: #a855f7 !important; font-weight: 800; } 
        .st-ABSENT { color: #ef4444 !important; font-weight: 900 !important; } 
        .st-COV { color: #3b82f6; font-size: 11px; display: block; margin-top: 4px; font-weight: bold; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .modal-box { background: white; padding: 35px; border-radius: 24px; width: 100%; max-width: 450px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-item { padding: 15px; border-radius: 12px; color: white; text-align: center; }
        .stat-val { font-size: 24px; font-weight: 900; display: block; }
        .stat-lbl { font-size: 12px; font-weight: 700; opacity: 0.9; }
    </style>
</head>
<body>

    <div id="view-login">
        <div class="login-card">
            <h1 style="margin-bottom:10px;">ShiftFlow</h1>
            <p style="font-weight:900; color:#10b981; font-size:13px; margin-bottom:20px;">V110 - SALES FIXED</p>
            <input type="password" id="pass-in" placeholder="CLAVE DE ACCESO">
            <button class="btn-main" onclick="startApp()">ENTRAR AL SISTEMA</button>
            <button class="btn-main" style="background:#ef4444; margin-top:20px;" onclick="hardReset()">REINICIAR APP (FIX)</button>
        </div>
    </div>

    <div id="view-app" class="hidden">
        <div class="nav">
            <div style="font-weight:900; letter-spacing:1px;">DREAMART SYSTEM</div>
            <div class="nav-actions">
                <button class="btn-main btn-gold" style="width:auto; padding:10px 20px; margin:0;" onclick="showStats()">ESTADÍSTICAS</button>
                <button class="btn-main btn-gold" style="width:auto; padding:10px 20px; margin:0;" onclick="showAdd()">+ MIEMBRO</button>
                <button class="btn-main" style="width:auto; padding:10px 20px; margin:0; background:#ef4444;" onclick="logout()">SALIR</button>
            </div>
        </div>
        <div id="pods-area"></div>
    </div>

    <!-- MODALS -->
    <div id="modal-status" class="modal hidden">
        <div class="modal-box">
            <h2 id="target-name" style="margin-top:0; color:#0f172a;"></h2>
            <div id="cov-zone" class="hidden" style="background:#f0f9ff; padding:20px; border-radius:16px; margin-bottom:20px; border:1px solid #bae6fd;">
                <label style="font-size:12px; font-weight:800; display:block; margin-bottom:10px;">¿A QUIÉN CUBRE?</label>
                <select id="cov-select"></select>
                <button class="btn-main" style="background:#0284c7;" onclick="confirmCov()">CONFIRMAR COBERTURA</button>
            </div>
            <div id="sick-zone" class="hidden" style="background:#f5f3ff; padding:20px; border-radius:16px; margin-bottom:20px; border:1px solid #ddd6fe;">
                <label style="font-size:12px; font-weight:800; display:block; margin-bottom:10px;">FECHA DE REINCORPORACIÓN:</label>
                <input type="date" id="sick-date">
                <button class="btn-main" style="background:#7c3aed;" onclick="confirmSick()">GUARDAR FECHA SICK</button>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <button class="btn-main" style="background:#10b981;" onclick="handleWorking()">WORKING (✓)</button>
                <button class="btn-main" style="background:#f97316;" onclick="saveSt('OFF')">OFF</button>
                <button class="btn-main" style="background:#ef4444;" onclick="saveSt('ABSENT')">ABSENT</button>
                <button class="btn-main" style="background:#a855f7;"
                    onclick="document.getElementById('sick-zone').classList.toggle('hidden')">SICK</button>
            </div>
            
            <!-- SALES SECTION -->
            <div style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:20px;">
                <label style="font-size:12px; font-weight:800; display:block; margin-bottom:10px; color:#0f172a;">VENTA DIARIA ($)</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="sale-amount" placeholder="0.00" style="margin:0;">
                    <button class="btn-main" style="width:auto; margin:0; background:#0f172a;" onclick="saveSale()">GUARDAR</button>
                </div>
            </div>

            <button class="btn-main" style="background:#64748b; margin-top:20px;" onclick="closeM()">CANCELAR</button>
        </div>
    </div>

    <div id="modal-add" class="modal hidden">
        <div class="modal-box">
            <h2 id="modal-title" style="margin-top:0;">Nuevo Miembro</h2>
            <input type="hidden" id="edit-id">
            <input type="text" id="add-name" placeholder="Nombre y Apellido">
            <input type="text" id="add-team" placeholder="Nombre del Equipo (Team)">
            <input type="text" id="add-model" placeholder="Nombre de la Modelo">
            <select id="add-pod">
                <option value="A">POD A</option><option value="B">POD B</option>
                <option value="F">POD F</option><option value="BACKUP">POD BACKUP</option>
            </select>
            <select id="add-role">
                <option value="Chatter">Chatter</option>
                <option value="Shadower">Shadower</option>
                <option value="Backup">Backup</option>
            </select>
            <select id="add-shift">
                <option value="1st">1st Shift</option><option value="2nd">2nd Shift</option><option value="3rd">3rd Shift</option>
            </select>
            <button id="btn-save" class="btn-main" onclick="doAdd()">GUARDAR MIEMBRO</button>
            <button id="btn-delete" class="btn-main hidden" style="background:#ef4444; margin-top:10px;" onclick="doDelete()">ELIMINAR MIEMBRO</button>
            <button class="btn-main" style="background:#64748b; margin-top:10px;" onclick="closeM()">CANCELAR</button>
        </div>
    </div>

    <div id="modal-stats" class="modal hidden">
        <div class="modal-box">
            <h2 style="margin-top:0;">Estadísticas Generales</h2>
            <div class="stats-grid">
                <div class="stat-item" style="background:#10b981;">
                    <span class="stat-val" id="st-work">0</span>
                    <span class="stat-lbl">WORKING</span>
                </div>
                <div class="stat-item" style="background:#ef4444;">
                    <span class="stat-val" id="st-absent">0</span>
                    <span class="stat-lbl">ABSENT</span>
                </div>
                <div class="stat-item" style="background:#a855f7;">
                    <span class="stat-val" id="st-sick">0</span>
                    <span class="stat-lbl">SICK</span>
                </div>
                <div class="stat-item" style="background:#f97316;">
                    <span class="stat-val" id="st-off">0</span>
                    <span class="stat-lbl">OFF</span>
                </div>
            </div>
            
            <div style="margin-top:25px; border-top:2px solid #f1f5f9; padding-top:20px;">
                <label style="font-weight:900; font-size:14px; text-transform:uppercase; color:#64748b;">Total Ventas</label>
                <div style="font-size:32px; font-weight:900; color:#0f172a; margin:10px 0;" id="st-sales-total">$0.00</div>
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button class="btn-main" style="padding:8px; font-size:11px; margin:0; background:#94a3b8;" onclick="filterSales(0)">HOY</button>
                    <button class="btn-main" style="padding:8px; font-size:11px; margin:0; background:#64748b;" onclick="filterSales(7)">7 DÍAS</button>
                    <button class="btn-main" style="padding:8px; font-size:11px; margin:0; background:#475569;" onclick="filterSales(14)">14 DÍAS</button>
                    <button class="btn-main" style="padding:8px; font-size:11px; margin:0; background:#0f172a;" onclick="filterSales(30)">30 DÍAS</button>
                </div>
            </div>

            <button class="btn-main" style="background:#64748b; margin-top:20px;" onclick="closeM()">CERRAR</button>
        </div>
    </div>

<script>
    // ERROR TRAP
    window.onerror = function(msg, url, line) {
        alert("Error Detectado: " + msg + "\nIntenta el botón REINICIAR APP.");
    };

    let db = { emps: [], sched: {}, sales: {} };
    let act = null;

    // Helper for consistent Date Keys
    function getIsoDate(dayStr) {
        try {
            const currentYear = new Date().getFullYear();
            const [d, m] = dayStr.split('/');
            return `${currentYear}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        } catch (e) { return null; }
    }

    // Check login
    try {
        if(localStorage.getItem('SF_LOGGED_IN') === 'true') {
            initData();
        }
    } catch(e) { console.error(e); }

    function startApp() { 
        if(document.getElementById('pass-in').value === '1234') {
            localStorage.setItem('SF_LOGGED_IN', 'true');
            initData();
        } else {
            alert("Clave Incorrecta"); 
        }
    }

    function hardReset() {
        if(confirm("¿BORRAR TODO Y REINICIAR? Se perderán los datos guardados.")) {
            localStorage.clear();
            location.reload();
        }
    }
    
    function logout() {
        localStorage.removeItem('SF_LOGGED_IN');
        location.reload();
    }

    function initData() {
        try {
            const saved = localStorage.getItem('SF_V107_FINAL');
            if(saved) {
                db = JSON.parse(saved);
                // Validate Structure
                if(!Array.isArray(db.emps)) throw new Error("Datos Corruptos");
                if(!db.sales) db.sales = {}; // Legacy support
            } else {
                // SEED DATA
                db.emps = [
                    { id: 1, name: 'User Demo 1', team: 'T1', model: 'M1', pod: 'A', shift: '1st' },
                    { id: 2, name: 'User Demo 2', team: 'T2', model: 'M2', pod: 'B', shift: '2nd' }
                ];
                db.sched = {};
                db.sales = {};
            }
        } catch(e) {
            alert("Error cargando datos. Se reiniciará la base de datos.");
            localStorage.removeItem('SF_V107_FINAL');
            db = { emps: [], sched: {}, sales: {} };
        }
        
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-app').classList.remove('hidden');
        render();
    }

    function render() {
        try {
            const area = document.getElementById('pods-area'); 
            if(!area) return;
            area.innerHTML = '';
            
            const days = ['28/1','29/1','30/1','31/1','01/2','02/2','03/2'];
            
            // 1. Helper to create a CARD + TABLE
            const renderCard = (title, list, labelOverride, bgColor) => {
                const safeList = list || [];
                
                let h = `<div class="pod-card"><div class="pod-header" style="background:${bgColor || '#f1f5f9'};"><span>${title}</span></div><div style="overflow-x:auto;"><table><thead><tr><th class="sc-1">TEAM</th><th class="sc-2">MODEL</th><th class="sc-3">${labelOverride || 'CHATTER'}</th>`;
                days.forEach(d => h += `<th>${d}</th>`);
                h += `</tr></thead><tbody>`;
                
                if(safeList.length === 0) {
                     h += `<tr><td colspan="${3 + days.length}" style="padding:20px; color:#94a3b8; font-style:italic;">Sin miembros asignados</td></tr>`;
                } else {
                    safeList.forEach(e => {
                        // Name cell is now clickable for editing
                        h += `<tr><td class="sc-1">${e.team || '-'}</td><td class="sc-2">${e.model || '-'}</td><td class="sc-3" style="cursor:pointer; color:#2563eb; font-weight:800;" onclick="editMember(${e.id})">${e.name} <span style="font-size:10px; opacity:0.7;">✎</span></td>`;
                        
                        days.forEach(d => {
                            const st = db.sched[e.id]?.[d] || 'WORKING'; 
                            let cls = 'st-WORKING', disp = '✓', sub = '';
                            
                            if(st === 'OFF') { cls = 'st-OFF'; disp = 'OFF'; }
                            if(st === 'ABSENT') { cls = 'st-ABSENT'; disp = 'ABSENT'; }
                            
                            if(typeof st === 'object') {
                                if(st.status === 'SICK') { 
                                    disp = 'SICK'; cls = 'st-SICK'; 
                                    sub = `<br><small style="color:#7c3aed; font-weight:600;">Regreso: ${st.date}</small>`; 
                                }
                                if(st.status === 'ON' && st.cov) { 
                                    disp = '✓'; cls = 'st-WORKING'; 
                                    sub = `<span class="st-COV">Cubriendo: ${st.cov}</span>`; 
                                }
                            }
                            
                            // Sales Indicator
                            const isoDate = getIsoDate(d);
                            if(isoDate && db.sales && db.sales[e.id] && db.sales[e.id][isoDate]) {
                                sub += `<span style="color:#10b981; font-weight:900; font-size:12px; margin-left:4px;">$${db.sales[e.id][isoDate]}</span>`;
                            }
                            
                            h += `<td onclick="openM(${e.id},'${d}','${e.name}')" style="cursor:pointer;"><span class="${cls}">${disp}</span>${sub}</td>`;
                        });
                        h += `</tr>`;
                    });
                }
                h += `</tbody></table></div></div>`;
                area.innerHTML += h;
            };

            // 2. RENDER PODS (A, B, F) -> ONLY CHATTERS
            const pods = [
                { id: 'A', color: '#dbeafe' }, // Blue-100
                { id: 'B', color: '#dcfce7' }, // Green-100
                { id: 'F', color: '#fae8ff' }  // Fuchsia-100 (Pinkish)
            ];

            pods.forEach(p => {
                const chatters = db.emps.filter(e => e.pod === p.id && (!e.role || e.role === 'Chatter'));
                renderCard(`POD ${p.id}`, chatters, 'CHATTER', p.color);
            });

            // 3. RENDER BACKUP TEAM
            const backups = db.emps.filter(e => e.role === 'Backup' || e.pod === 'BACKUP');
            renderCard('BACKUP TEAM', backups, 'BACKUP', '#ffedd5'); // Orange-100

            // 4. RENDER SHADOWERS TEAM
            const shadowers = db.emps.filter(e => e.role === 'Shadower');
            renderCard('SHADOWERS TEAM', shadowers, 'SHADOWER', '#f3e8ff'); // Purple-100

        } catch(e) {
            console.error("Render Error", e);
            alert("Error mostrando la tabla: " + e.message);
        }
    }

    function handleWorking() {
        try {
            const others = db.emps.filter(e => e.id !== act.id);
            const absents = others.filter(o => ['OFF','ABSENT'].includes(db.sched[o.id]?.[act.key]));
            
            if(absents.length > 0) {
                const sel = document.getElementById('cov-select'); 
                sel.innerHTML = '<option value="">NORMAL (SIN COBERTURA)</option>';
                absents.forEach(a => sel.innerHTML += `<option value="${a.name}">${a.name}</option>`);
                document.getElementById('cov-zone').classList.remove('hidden');
            } else {
                saveSt('WORKING');
            }
        } catch(e) { alert("Error: " + e.message); }
    }

    function confirmCov() { 
        const covName = document.getElementById('cov-select').value;
        if(covName) saveSt({status: 'ON', cov: covName});
        else saveSt('WORKING');
    }
    
    function confirmSick() { 
        const date = document.getElementById('sick-date').value;
        if(!date) return alert("Selecciona fecha");
        saveSt({status: 'SICK', date: date}); 
    }

    function showStats() {
        let work=0, off=0, abs=0, sick=0;
        const days = ['28/1','29/1','30/1','31/1','01/2','02/2','03/2']; // Visible days
        
        db.emps.forEach(e => {
            days.forEach(d => {
                const st = db.sched[e.id]?.[d] || 'WORKING';
                if(st === 'WORKING') work++;
                else if(st === 'OFF') off++;
                else if(st === 'ABSENT') abs++;
                else if(typeof st === 'object') {
                    if(st.status === 'SICK') sick++;
                    if(st.status === 'ON') work++;
                }
            });
        });
        
        document.getElementById('st-work').innerText = work;
        document.getElementById('st-off').innerText = off;
        document.getElementById('st-absent').innerText = abs;
        document.getElementById('st-sick').innerText = sick;
        
        filterSales(0); // Default to Today
        document.getElementById('modal-stats').classList.remove('hidden');
    }
    
    function filterSales(range) {
        // Range: 0=Today, 7, 14, 30
        
        const now = new Date(); 
        let total = 0;
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - range);
        
        // Normalize dates to midnight
        const today = new Date(); today.setHours(0,0,0,0);
        cutoff.setHours(0,0,0,0);
        
        // Loop all sales
        Object.values(db.sales).forEach(empSales => {
            Object.entries(empSales).forEach(([dateStr, amount]) => {
                // dateStr is "YYYY-MM-DD"
                if(!dateStr) return;
                const [y, m, d] = dateStr.split('-').map(Number);
                const date = new Date(y, m-1, d);
                
                if (range === 0) {
                    // Special case for TODAY
                    if(date.getTime() === today.getTime()) total += amount;
                } else {
                    if(date >= cutoff && date <= today) total += amount;
                }
            });
        });
        
        document.getElementById('st-sales-total').innerText = "$" + total.toFixed(2);
    }

    function openM(id, k, n) { 
        act = { id, key: k, n }; 
        document.getElementById('target-name').innerText = n; 
        
        act.isoDate = getIsoDate(k);
        
        const amount = (db.sales && db.sales[id] && db.sales[id][act.isoDate]) ? db.sales[id][act.isoDate] : "";
        document.getElementById('sale-amount').value = amount;
        
        document.querySelectorAll('#modal-status .hidden').forEach(z=>z.classList.add('hidden')); 
        document.getElementById('modal-status').classList.remove('hidden'); 
    }
    
    function saveSale() {
        if(!act



