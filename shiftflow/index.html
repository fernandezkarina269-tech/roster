<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamArt V110 - SALES FIXED</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --gold: #FFD700;
            --bg: #121212;
            --accent: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: #f8fafc;
            color: #0f172a;
            padding-bottom: 60px;
        }

        .hidden {
            display: none !important;
        }

        /* LOGIN PREMIUM */
        #view-login {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 50px 40px;
            border-radius: 32px;
            text-align: center;
            width: 360px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            color: white;
        }

        /* PREMIUM INPUTS */
        input,
        select {
            width: 100%;
            padding: 16px;
            margin: 12px 0;
            background: rgba(255, 255, 255, 0.05);
            /* Darker glass for inputs */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            font-size: 16px;
            color: #fff;
            /* White text for dark backgrounds */
            font-weight: 500;
            transition: 0.3s;
            outline: none;
        }

        /* Modal Inputs override - Modals are white, so inputs need dark text */
        .modal-box input,
        .modal-box select {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #0f172a;
        }

        .modal-box input:focus,
        .modal-box select:focus {
            border-color: var(--gold);
            background: white;
        }

        /* Login Input Focus */
        .login-card input:focus {
            border-color: var(--gold);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        /* BUTTONS */
        .btn-main {
            padding: 18px;
            width: 100%;
            background: linear-gradient(135deg, #FFD700, #FDB931);
            color: #000;
            border: none;
            font-weight: 900;
            cursor: pointer;
            border-radius: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);
        }

        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(255, 215, 0, 0.3);
        }

        .btn-gold {
            background: var(--gold);
            color: #000;
        }

        /* NAV */
        .nav {
            background: #000;
            color: #fff;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 5px solid var(--gold);
        }

        .nav-actions {
            display: flex;
            gap: 10px;
        }

        /* TABLES */
        .pod-card {
            background: white;
            border-radius: 16px;
            margin: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .pod-header {
            background: #f1f5f9;
            padding: 16px 20px;
            font-weight: 800;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1300px;
        }

        th {
            background: #0f172a;
            color: white;
            padding: 14px;
            font-size: 12px;
            text-transform: uppercase;
        }

        td {
            padding: 14px;
            text-align: center;
            border-bottom: 1px solid #f1f5f9;
            font-weight: 700;
            font-size: 14px;
        }

        /* FIXED COLS */
        .sc-1 {
            position: sticky;
            left: 0;
            background: #fff !important;
            z-index: 10;
            width: 100px;
            border-right: 1px solid #e2e8f0;
        }

        .sc-2 {
            position: sticky;
            left: 100px;
            background: #fff !important;
            z-index: 10;
            width: 120px;
            border-right: 1px solid #e2e8f0;
        }

        .sc-3 {
            position: sticky;
            left: 220px;
            background: #fff !important;
            z-index: 10;
            border-right: 2px solid #cbd5e1;
            width: 180px;
            text-align: left;
            padding-left: 15px;
        }

        /* STATUS COLORS */
        .st-WORKING {
            color: #10b981 !important;
            font-weight: 900 !important;
            font-size: 18px;
        }

        .st-OFF {
            color: #f97316 !important;
            font-weight: 900 !important;
        }

        .st-SICK {
            color: #a855f7 !important;
            font-weight: 800;
        }

        .st-ABSENT {
            color: #ef4444 !important;
            font-weight: 900 !important;
        }

        .st-COV {
            color: #3b82f6;
            font-size: 11px;
            display: block;
            margin-top: 4px;
            font-weight: bold;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-box {
            background: white;
            padding: 35px;
            border-radius: 24px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            padding: 15px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .stat-val {
            font-size: 24px;
            font-weight: 900;
            display: block;
        }

        .stat-lbl {
            font-size: 12px;
            font-weight: 700;
            opacity: 0.9;
        }

        /* SHIFT SHEETS */
        .shift-sheet {
            margin-bottom: 60px;
            border-top: 5px solid #0f172a;
        }

        .shift-sheet-header {
            background: #0f172a;
            color: white;
            padding: 20px 40px;
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-sheet-header .badge {
            background: var(--gold);
            color: #000;
            padding: 5px 15px;
            border-radius: 99px;
            font-size: 14px;
        }
    </style>
</head>

<body>

    <div id="view-login">
        <div class="login-card">
            <h1 style="margin-bottom:10px;">ShiftFlow</h1>
            <p style="font-weight:900; color:#10b981; font-size:13px; margin-bottom:20px;">V109 - STABLE</p>
            <input type="password" id="pass-in" placeholder="CLAVE DE ACCESO">
            <button class="btn-main" onclick="startApp()">ENTRAR AL SISTEMA</button>
            <button class="btn-main" style="background:#ef4444; margin-top:20px;" onclick="hardReset()">REINICIAR APP
                (FIX)</button>
        </div>
    </div>

    <div id="view-app" class="hidden">
        <div class="nav">
            <div style="font-weight:900; letter-spacing:1px;">DREAMART SYSTEM</div>
            <div class="nav-actions">
                <button class="btn-main btn-gold" style="width:auto; padding:10px 20px; margin:0;"
                    onclick="showStats()">ESTAD√çSTICAS</button>
                <button class="btn-main btn-gold" style="width:auto; padding:10px 20px; margin:0;" onclick="showAdd()">+
                    MIEMBRO</button>
                <button class="btn-main" style="width:auto; padding:10px 20px; margin:0; background:#ef4444;"
                    onclick="logout()">SALIR</button>
            </div>
        </div>
        <div id="sheets-container"></div>
    </div>

    <!-- MODALS -->
    <div id="modal-status" class="modal hidden">
        <div class="modal-box">
            <h2 id="target-name" style="margin-top:0; color:#0f172a;"></h2>
            <div id="cov-zone" class="hidden"
                style="background:#f0f9ff; padding:20px; border-radius:16px; margin-bottom:20px; border:1px solid #bae6fd;">
                <label style="font-size:12px; font-weight:800; display:block; margin-bottom:10px;">¬øA QUI√âN
                    CUBRE?</label>
                <select id="cov-select"></select>
                <button class="btn-main" style="background:#0284c7;" onclick="confirmCov()">CONFIRMAR COBERTURA</button>
            </div>
            <div id="sick-zone" class="hidden"
                style="background:#f5f3ff; padding:20px; border-radius:16px; margin-bottom:20px; border:1px solid #ddd6fe;">
                <label style="font-size:12px; font-weight:800; display:block; margin-bottom:10px;">FECHA DE
                    REINCORPORACI√ìN:</label>
                <input type="date" id="sick-date">
                <button class="btn-main" style="background:#7c3aed;" onclick="confirmSick()">GUARDAR FECHA SICK</button>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <button class="btn-main" style="background:#10b981;" onclick="handleWorking()">WORKING (‚úì)</button>
                <button class="btn-main" style="background:#f97316;" onclick="saveSt('OFF')">OFF</button>
                <button class="btn-main" style="background:#ef4444;" onclick="saveSt('ABSENT')">ABSENT</button>
                <button class="btn-main" style="background:#a855f7;"
                    onclick="document.getElementById('sick-zone').classList.toggle('hidden')">SICK</button>
            </div>

            <!-- SALES SECTION -->
            <div style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:20px;">
                <label style="font-size:12px; font-weight:800; display:block; margin-bottom:10px; color:#0f172a;">VENTA
                    DIARIA ($)</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="sale-amount" placeholder="0.00" style="margin:0;">
                    <button class="btn-main" style="width:auto; margin:0; background:#0f172a;"
                        onclick="saveSale()">GUARDAR</button>
                </div>
            </div>

            <button class="btn-main" style="background:#64748b; margin-top:20px;" onclick="closeM()">CANCELAR</button>
        </div>
    </div>

    <div id="modal-add" class="modal hidden">
        <div class="modal-box">
            <h2 id="modal-title" style="margin-top:0;">Nuevo Miembro</h2>
            <input type="hidden" id="edit-id">
            <input type="text" id="add-name" placeholder="Nombre y Apellido">
            <input type="text" id="add-team" placeholder="Nombre del Equipo (Team)">
            <input type="text" id="add-model" placeholder="Nombre de la Modelo">
            <select id="add-pod">
                <option value="A">POD A</option>
                <option value="B">POD B</option>
                <option value="F">POD F</option>
                <option value="BACKUP">POD BACKUP</option>
            </select>
            <select id="add-role">
                <option value="Chatter">Chatter</option>
                <option value="Shadower">Shadower</option>
                <option value="Backup">Backup</option>
            </select>
            <select id="add-shift">
                <option value="1st">1st Shift</option>
                <option value="2nd">2nd Shift</option>
                <option value="3rd">3rd Shift</option>
            </select>
            <button id="btn-save" class="btn-main" onclick="doAdd()">GUARDAR MIEMBRO</button>
            <button id="btn-delete" class="btn-main hidden" style="background:#ef4444; margin-top:10px;"
                onclick="doDelete()">ELIMINAR MIEMBRO</button>
            <button class="btn-main" style="background:#64748b; margin-top:10px;" onclick="closeM()">CANCELAR</button>
        </div>
    </div>

    <div id="modal-stats" class="modal hidden">
        <div class="modal-box">
            <h2 style="margin-top:0;">Estad√≠sticas Generales</h2>
            <div class="stats-grid">
                <div class="stat-item" style="background:#10b981;">
                    <span class="stat-val" id="st-work">0</span>
                    <span class="stat-lbl">WORKING</span>
                </div>
                <div class="stat-item" style="background:#ef4444;">
                    <span class="stat-val" id="st-absent">0</span>
                    <span class="stat-lbl">ABSENT</span>
                </div>
                <div class="stat-item" style="background:#a855f7;">
                    <span class="stat-val" id="st-sick">0</span>
                    <span class="stat-lbl">SICK</span>
                </div>
                <div class="stat-item" style="background:#f97316;">
                    <span class="stat-val" id="st-off">0</span>
                    <span class="stat-lbl">OFF</span>
                </div>
            </div>

            <div style="margin-top:25px; border-top:2px solid #f1f5f9; padding-top:20px;">
                <label style="font-weight:900; font-size:14px; text-transform:uppercase; color:#64748b;">Ventas por
                    POD</label>
                <div style="height: 200px; margin-top: 10px; margin-bottom: 20px;">
                    <canvas id="salesChart"></canvas>
                </div>
                <label style="font-weight:900; font-size:14px; text-transform:uppercase; color:#64748b;">Total
                    Ventas</label>
                <div style="font-size:32px; font-weight:900; color:#0f172a; margin:10px 0;" id="st-sales-total">$0.00
                </div>
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button class="btn-main" style="padding:8px; font-size:11px; margin:0; background:#94a3b8;"
                        onclick="filterSales(0)">HOY</button>
                    <button class="btn-main" style="padding:8px; font-size:11px; margin:0; background:#64748b;"
                        onclick="filterSales(7)">7 D√çAS</button>
                    <button class="btn-main" style="padding:8px; font-size:11px; margin:0; background:#475569;"
                        onclick="filterSales(14)">14 D√çAS</button>
                    <button class="btn-main" style="padding:8px; font-size:11px; margin:0; background:#0f172a;"
                        onclick="filterSales(30)">30 D√çAS</button>
                </div>
            </div>

            <button class="btn-main" style="background:#64748b; margin-top:20px;" onclick="closeM()">CERRAR</button>
        </div>
    </div>

    <script>
        // ERROR TRAP
        window.onerror = function (msg, url, line) {
            alert("Error Detectado: " + msg + "\nIntenta el bot√≥n REINICIAR APP.");
        };

        let db = { emps: [], sched: {}, sales: {}, notes: {} };
        let act = null;
        let salesChartInst = null;

        function getIsoDate(dStr) {
            const [d, m] = dStr.split('/').map(Number);
            const year = (m >= 10) ? 2025 : 2026; // Manual fix for Jan/Feb overlap
            return `${year}-${m.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
        }

        function initData() {
            try {
                const saved = localStorage.getItem('SF_V107_FINAL');
                if (saved) {
                    db = JSON.parse(saved);
                    if (!Array.isArray(db.emps)) throw new Error("Datos Corruptos");
                    if (!db.sales) db.sales = {};
                    if (!db.notes) db.notes = {}; // Initialize notes
                } else {
                    // SEED
                    db.emps = [
                        { id: 1, name: 'User Demo 1', team: 'T1', model: 'M1', pod: 'A', shift: '1st' },
                        { id: 2, name: 'User Demo 2', team: 'T2', model: 'M2', pod: 'B', shift: '2nd' }
                    ];
                    db.sched = {}; db.sales = {}; db.notes = {};
                }
            } catch (e) {
                alert("Error cargando datos. Se reiniciar√° la base de datos.");
                localStorage.removeItem('SF_V107_FINAL');
                db = { emps: [], sched: {}, sales: {}, notes: {} };
            }

            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            render();
        }

        function render() {
            try {
                const container = document.getElementById('sheets-container');
                if (!container) return;
                container.innerHTML = '';

                const shifts = ['1st', '2nd', '3rd'];
                const days = ['28/1', '29/1', '30/1', '31/1', '01/2', '02/2', '03/2'];

                shifts.forEach(shiftName => {
                    const sheetDiv = document.createElement('div');
                    sheetDiv.className = 'shift-sheet';
                    sheetDiv.innerHTML = `<div class="shift-sheet-header">
                        <span>${shiftName} SHIFT</span>
                        <span class="badge" id="badge-${shiftName}">0 Salidas</span>
                    </div>
                    <div id="area-${shiftName}"></div>`;
                    container.appendChild(sheetDiv);

                    const area = document.getElementById(`area-${shiftName}`);
                    const shiftEmps = db.emps.filter(e => e.shift === shiftName || (shiftName === '1st' && !e.shift));

                    const renderCard = (title, list, labelOverride, bgColor) => {
                        const safeList = list || [];
                        const podId = `${shiftName}-${title}`; // Unique note ID per shift/pod
                        const noteVal = (db.notes && db.notes[podId]) ? db.notes[podId] : '';

                        let h = `<div class="pod-card">
                        <div class="pod-header" style="background:${bgColor || '#f1f5f9'};"><span>${title}</span></div>
                        
                        <div style="padding:10px 20px; background:#fff; border-bottom:1px solid #e2e8f0;">
                            <textarea placeholder="Notas del equipo..." 
                                style="width:100%; border:1px solid #cbd5e1; border-radius:8px; padding:8px; font-family:'Inter',sans-serif; height:60px; resize:vertical;"
                                onblur="saveNote('${podId}', this.value)">${noteVal}</textarea>
                        </div>

                        <div style="overflow-x:auto;"><table><thead><tr><th class="sc-1">TEAM</th><th class="sc-2">MODEL</th><th class="sc-3">${labelOverride || 'CHATTER'}</th>`;
                        days.forEach(d => h += `<th>${d}</th>`);
                        h += `</tr></thead><tbody>`;

                        if (safeList.length === 0) {
                            h += `<tr><td colspan="${3 + days.length}" style="padding:20px; color:#94a3b8; font-style:italic;">Sin miembros asignados</td></tr>`;
                        } else {
                            safeList.forEach(e => {
                                h += `<tr><td class="sc-1">${e.team || '-'}</td><td class="sc-2">${e.model || '-'}</td><td class="sc-3" style="cursor:pointer; color:#2563eb; font-weight:800;" onclick="editMember(${e.id})">${e.name} <span style="font-size:10px; opacity:0.7;">‚úé</span></td>`;
                                days.forEach(d => {
                                    const st = db.sched[e.id]?.[d] || 'WORKING';
                                    let cls = 'st-WORKING', disp = '‚úì', sub = '';
                                    const status = (typeof st === 'object') ? st.status : st;
                                    if (status === 'OFF') { cls = 'st-OFF'; disp = 'OFF'; }
                                    if (status === 'ABSENT') { cls = 'st-ABSENT'; disp = 'ABSENT'; }
                                    if (typeof st === 'object') {
                                        if (st.status === 'SICK') {
                                            disp = 'üöë SICK'; cls = 'st-SICK';
                                            sub = `<br><small style="color:#7c3aed; font-weight:600;">Regreso: ${st.date}</small>`;
                                        }
                                        if (st.status === 'ON' && st.cov) {
                                            disp = '‚úì'; cls = 'st-WORKING';
                                            if (st.cov !== 'Lugar Vac√≠o') { sub = `<span class="st-COV">Covering... ${st.cov}</span>`; }
                                        }
                                    }
                                    const isoDate = getIsoDate(d);
                                    if (isoDate && db.sales && db.sales[e.id] && db.sales[e.id][isoDate]) {
                                        sub += `<span style="color:#10b981; font-weight:900; font-size:12px; margin-left:4px;">$${db.sales[e.id][isoDate]}</span>`;
                                    }
                                    h += `<td onclick="openM(${e.id},'${d}','${e.name}')" style="cursor:pointer;"><span class="${cls}">${disp}</span>${sub}</td>`;
                                });
                                h += `</tr>`;
                            });
                        }
                        h += `</tbody></table></div></div>`;
                        area.innerHTML += h;
                    };

                    const pods = [{ id: 'A', color: '#dbeafe' }, { id: 'B', color: '#dcfce7' }, { id: 'F', color: '#fae8ff' }];
                    pods.forEach(p => {
                        const chatters = shiftEmps.filter(e => e.pod === p.id && (!e.role || e.role === 'Chatter'));
                        renderCard(`POD ${p.id}`, chatters, 'CHATTER', p.color);
                    });
                    renderCard('BACKUP TEAM', shiftEmps.filter(e => e.role === 'Backup' || e.pod === 'BACKUP'), 'BACKUP', '#ffedd5');
                    renderCard('SHADOWERS TEAM', shiftEmps.filter(e => e.role === 'Shadower'), 'SHADOWER', '#f3e8ff');
                });
            } catch (e) {
                console.error("Render Error", e);
                alert("Error mostrando la tabla: " + e.message);
            }
        }

        function handleWorking() {
            try {
                const me = db.emps.find(e => e.id === act.id);
                // Check if user is backup (role or pod)
                const isBackup = (me.role === 'Backup' || me.pod === 'BACKUP');

                if (!isBackup) {
                    saveSt('WORKING');
                    return;
                }

                // It is a backup, find targets (SICK or ABSENT)
                const others = db.emps.filter(e => e.id !== act.id);
                const targets = others.filter(o => {
                    const stRaw = db.sched[o.id]?.[act.key];
                    const status = (typeof stRaw === 'object') ? stRaw.status : stRaw;
                    return ['SICK', 'ABSENT'].includes(status);
                });

                const sel = document.getElementById('cov-select');
                sel.innerHTML = '<option value="">-- SELECCIONA OPCI√ìN --</option>';
                sel.innerHTML += '<option value="Lugar Vac√≠o">LUGAR VAC√çO</option>';

                targets.forEach(t => {
                    sel.innerHTML += `<option value="${t.name}">${t.name} (${t.pod})</option>`;
                });

                document.getElementById('cov-zone').classList.remove('hidden');

            } catch (e) { alert("Error: " + e.message); }
        }

        function confirmCov() {
            const covName = document.getElementById('cov-select').value;
            if (covName) saveSt({ status: 'ON', cov: covName });
            else saveSt('WORKING');
        }

        function confirmSick() {
            const date = document.getElementById('sick-date').value;
            if (!date) return alert("Selecciona fecha");

            const admin = prompt("¬øQui√©n eres? (Admin que resuelve)");
            if (!admin) return alert("Se requiere nombre de Admin para procesar la alerta.");

            alert(`üî¥ ALERTA: ${admin} resolvi√≥ alerta de ${act.n} -> SICK`);
            saveSt({ status: 'SICK', date: date, resolver: admin });
        }

        function showStats() {
            let totalSales = 0;
            let totalWork = 0, totalOff = 0, totalAbs = 0, totalSick = 0;
            const days = ['28/1', '29/1', '30/1', '31/1', '01/2', '02/2', '03/2'];

            db.emps.forEach(e => {
                days.forEach(d => {
                    const st = db.sched[e.id]?.[d] || 'WORKING';
                    if (st === 'WORKING' || (typeof st === 'object' && st.status === 'ON')) totalWork++;
                    else if (st === 'OFF') totalOff++;
                    else if (st === 'ABSENT' || (typeof st === 'object' && st.status === 'ABSENT')) totalAbs++;
                    else if (typeof st === 'object' && st.status === 'SICK') totalSick++;
                });
            });

            document.getElementById('st-work').innerText = totalWork;
            document.getElementById('st-off').innerText = totalOff;
            document.getElementById('st-absent').innerText = totalAbs;
            document.getElementById('st-sick').innerText = totalSick;

            filterSales(0); // Today global sales for chart/total summary
            document.getElementById('modal-stats').classList.remove('hidden');
        }

        function filterSales(range) {
            const cutoff = new Date();
            const today = new Date(); today.setHours(0, 0, 0, 0);
            cutoff.setDate(today.getDate() - range);
            cutoff.setHours(0, 0, 0, 0);

            // Prep Chart Labels
            const labels = [];
            const podSales = { 'A': {}, 'B': {}, 'F': {}, 'BACKUP': {} };
            const startChart = new Date(today);
            startChart.setDate(today.getDate() - (range || 6));

            for (let d = new Date(startChart); d <= today; d.setDate(d.getDate() + 1)) {
                const day = d.getDate().toString().padStart(2, '0');
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const label = `${day}/${month}`;
                const iso = `${d.getFullYear()}-${month}-${day}`;
                labels.push({ label, iso });
                Object.keys(podSales).forEach(p => podSales[p][iso] = 0);
            }

            let totalSum = 0;
            db.emps.forEach(emp => {
                const empPod = emp.pod || 'A';
                if (db.sales && db.sales[emp.id]) {
                    Object.entries(db.sales[emp.id]).forEach(([dateStr, amount]) => {
                        const [y, m, d] = dateStr.split('-').map(Number);
                        const date = new Date(y, m - 1, d);
                        date.setHours(0, 0, 0, 0);

                        if (range === 0) {
                            if (date.getTime() === today.getTime()) totalSum += amount;
                        } else {
                            if (date >= cutoff && date <= today) totalSum += amount;
                        }

                        if (podSales[empPod] && podSales[empPod].hasOwnProperty(dateStr)) {
                            podSales[empPod][dateStr] += amount;
                        }
                    });
                }
            });

            document.getElementById('st-sales-total').innerText = "$" + totalSum.toFixed(2);

            const chartLabels = labels.map(l => l.label);
            const chartData = {
                'A': labels.map(l => podSales['A'][l.iso]),
                'B': labels.map(l => podSales['B'][l.iso]),
                'F': labels.map(l => podSales['F'][l.iso]),
                'BACKUP': labels.map(l => podSales['BACKUP'][l.iso])
            };
            renderSalesChart(chartLabels, chartData);
        }

        function renderSalesChart(labels, data) {
            const canvas = document.getElementById('salesChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (salesChartInst) salesChartInst.destroy();

            salesChartInst = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'POD A', data: data['A'], borderColor: '#3b82f6', backgroundColor: '#3b82f6', tension: 0.3, fill: false, borderWidth: 3, pointRadius: 4 },
                        { label: 'POD B', data: data['B'], borderColor: '#10b981', backgroundColor: '#10b981', tension: 0.3, fill: false, borderWidth: 3, pointRadius: 4 },
                        { label: 'POD F', data: data['F'], borderColor: '#f43f5e', backgroundColor: '#f43f5e', tension: 0.3, fill: false, borderWidth: 3, pointRadius: 4 },
                        { label: 'BACKUP', data: data['BACKUP'], borderColor: '#f59e0b', backgroundColor: '#f59e0b', tension: 0.3, fill: false, borderWidth: 3, pointRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10, weight: 'bold' } } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 10 } }, grid: { color: '#f1f5f9' } },
                        x: { ticks: { font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
        }

        function openM(id, k, n) {
            act = { id, key: k, n };
            document.getElementById('target-name').innerText = n;

            act.isoDate = getIsoDate(k);

            const amount = (db.sales && db.sales[id] && db.sales[id][act.isoDate]) ? db.sales[id][act.isoDate] : "";
            document.getElementById('sale-amount').value = amount;

            // RESET ZONES
            document.getElementById('cov-zone').classList.add('hidden');
            document.getElementById('sick-zone').classList.add('hidden');

            document.getElementById('modal-status').classList.remove('hidden');
        }

        function saveSale() {
            if (!act) return;
            const amount = parseFloat(document.getElementById('sale-amount').value);

            if (!db.sales) db.sales = {};
            if (!db.sales[act.id]) db.sales[act.id] = {};

            if (isNaN(amount) || amount === 0) {
                if (db.sales[act.id][act.isoDate]) delete db.sales[act.id][act.isoDate];
            } else {
                db.sales[act.id][act.isoDate] = amount;
            }
            alert("¬°Venta Guardada: $" + amount + "!\nFecha: " + act.isoDate);
            save(); // Closes modal
        }

        function showAdd() {
            document.getElementById('modal-title').innerText = "Nuevo Miembro";
            document.getElementById('edit-id').value = "";
            document.getElementById('add-name').value = "";
            document.getElementById('add-team').value = "";
            document.getElementById('add-model').value = "";
            document.getElementById('add-pod').value = "A";
            document.getElementById('add-role').value = "Chatter";
            document.getElementById('add-shift').value = "1st";
            document.getElementById('btn-save').innerText = "GUARDAR MIEMBRO";
            document.getElementById('btn-delete').classList.add('hidden');
            document.getElementById('modal-add').classList.remove('hidden');
        }

        function editMember(id) {
            const e = db.emps.find(x => x.id === id);
            if (!e) return;
            document.getElementById('modal-title').innerText = "Editar Miembro";
            document.getElementById('edit-id').value = e.id;
            document.getElementById('add-name').value = e.name;
            document.getElementById('add-team').value = e.team || "";
            document.getElementById('add-model').value = e.model || "";
            document.getElementById('add-pod').value = e.pod || "A";
            document.getElementById('add-role').value = e.role || "Chatter";
            document.getElementById('add-shift').value = e.shift || "1st";
            document.getElementById('btn-save').innerText = "ACTUALIZAR DATOS";
            document.getElementById('btn-delete').classList.remove('hidden');
            document.getElementById('modal-add').classList.remove('hidden');
        }

        function doDelete() {
            const id = parseInt(document.getElementById('edit-id').value);
            if (!id) return;
            if (confirm("¬øEliminar este miembro permanentemente?")) {
                db.emps = db.emps.filter(e => e.id !== id);
                delete db.sched[id];
                save();
            }
        }

        function closeM() { document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden')); }
        function saveSt(s) {
            if (!act) return;

            // Intercept ABSENT for Alert
            if (s === 'ABSENT') {
                const admin = prompt("¬øQui√©n eres? (Admin que resuelve)");
                if (!admin) return alert("Se requiere nombre de Admin para procesar la alerta.");
                alert(`üî¥ ALERTA: ${admin} resolvi√≥ alerta de ${act.n} -> ABSENT`);
                s = { status: 'ABSENT', resolver: admin };
            }

            if (!db.sched[act.id]) db.sched[act.id] = {};
            db.sched[act.id][act.key] = s;
            save();
        }

        function saveNote(podId, text) {
            if (!db.notes) db.notes = {};
            db.notes[podId] = text;
            localStorage.setItem('SF_V107_FINAL', JSON.stringify(db));
            // No render needed as it handles onblur
        }

        function doAdd() {
            const name = document.getElementById('add-name').value;
            if (!name) return alert("Nombre requerido");

            const editId = document.getElementById('edit-id').value;
            if (editId) {
                const id = parseInt(editId);
                const idx = db.emps.findIndex(e => e.id === id);
                if (idx !== -1) {
                    db.emps[idx].name = name;
                    db.emps[idx].team = document.getElementById('add-team').value;
                    db.emps[idx].model = document.getElementById('add-model').value;
                    db.emps[idx].pod = document.getElementById('add-pod').value;
                    db.emps[idx].shift = document.getElementById('add-shift').value;
                    db.emps[idx].role = document.getElementById('add-role').value;
                }
            } else {
                db.emps.push({
                    id: Date.now(),
                    name: name,
                    team: document.getElementById('add-team').value,
                    model: document.getElementById('add-model').value,
                    pod: document.getElementById('add-pod').value,
                    shift: document.getElementById('add-shift').value,
                    role: document.getElementById('add-role').value
                });
            }
            save();
        }

        function save() { localStorage.setItem('SF_V107_FINAL', JSON.stringify(db)); closeM(); render(); }

        function logout() { localStorage.removeItem('SF_LOGGED'); location.reload(); }
        
        function hardReset() {
            if (confirm("¬øReiniciar base de datos completa?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function startApp() {
             const pin = document.getElementById('pass-in').value;
             if (pin === '0129') {
                 localStorage.setItem('SF_LOGGED', 'true');
                 initData();
             } else {
                 alert("PIN INCORRECTO");
             }
        }

        // Auto-login check
        if (localStorage.getItem('SF_LOGGED')) {
            initData();
        }
    </script>
</body>

</html>








